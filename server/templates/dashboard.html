{% extends "base.html" %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        var socket = io();

        socket.on('connect', function() {
            console.log("Connected to Dashboard. Requesting ALL streams.");
            // Send empty object -> Request ALL logs
            socket.emit('start_monitoring', {});
        });

        // 1. Host Status Updates
        socket.on('host_status_update', function(data) {
            var statusSpan = document.getElementById("status-" + data.host_id);
            var lastSeenCell = document.getElementById("last-seen-" + data.host_id);

            if (statusSpan) {
                if (data.is_online) {
                    statusSpan.style.color = "green";
                    statusSpan.innerText = "Online";
                } else {
                    statusSpan.style.color = "red";
                    statusSpan.innerText = "Offline";
                }
            }
            if (lastSeenCell) {
                lastSeenCell.innerText = data.last_seen;
            }
        });

        // 2. New Log Updates
        socket.on('new_log', function(data) {
            var tableBody = document.querySelector("#logs-table tbody");
            if (!tableBody) return; // Safety check

            var row = tableBody.insertRow(0);
            
            // Highlight animation
            row.style.backgroundColor = "#e8f5e9";
            setTimeout(() => { row.style.transition = "background 1s"; row.style.backgroundColor = "transparent"; }, 500);

            var color = 'black';
            if(data.severity === 'critical') color = 'red';
            else if(data.severity === 'warning') color = 'orange';

            // Safe message handling (handle nulls)
            var safeMessage = (data.message || "").substring(0, 100);

            row.innerHTML = `
                <td>${data.timestamp}</td>
                <td>${data.hostname}</td>
                <td>${data.program}</td>
                <td style="font-family: monospace;">${safeMessage}...</td>
                <td style="font-weight: bold; color: ${color}">${data.severity}</td>
            `;

            if(tableBody.rows.length > 20) {
                tableBody.deleteRow(20);
            }
        });
    });
</script>

<h2>System Overview</h2>

<div class="card">
    <h3>Active Hosts</h3>
    {% if hosts %}
        <table>
            <thead>
                <tr>
                    <th>Hostname</th>
                    <th>IP Address</th>
                    <th>Last Heartbeat</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for host in hosts %}
                <tr>
                    <td>
                        <a href="{{ url_for('host_details', host_id=host.id) }}" style="font-weight: bold; color: #2980b9; text-decoration: none;">
                            {{ host.hostname }}
                        </a>
                    </td>
                    <td>{{ host.ip_address }}</td>
                    <td id="last-seen-{{ host.id }}">{{ host.last_heartbeat.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>
                        <span id="status-{{ host.id }}" style="color: {{ 'green' if host.is_online else 'red' }}">
                            {{ 'Online' if host.is_online else 'Offline' }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No hosts registered yet.</p>
    {% endif %}
</div>

<div class="card">
    <h3>Recent Audit Logs</h3>
    <table id="logs-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Host</th>
                <th>Program</th>
                <th>Message</th>
                <th>Severity</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.timestamp.strftime('%H:%M:%S') }}</td>
                <td>{{ log.host.hostname }}</td>
                <td>{{ log.program }}</td>
                <td style="font-family: monospace;">{{ log.message[:100] }}...</td>
                <td style="font-weight: bold; color: {{ 'red' if log.severity.value == 'critical' else 'orange' if log.severity.value == 'warning' else 'black' }}">
                    {{ log.severity.value }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}