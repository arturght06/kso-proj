{% extends "base.html" %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
    // Funkcja pomocnicza do przeładowania strony z nowym limitem
    function changeLimit(limit) {
        const url = new URL(window.location.href);
        url.searchParams.set('limit', limit);
        window.location.href = url.toString();
    }

    // Funkcja do pokazywania/ukrywania surowego loga
    function toggleDetails(rowId) {
        var x = document.getElementById("raw-" + rowId);
        if (x.style.display === "none") {
            x.style.display = "table-row";
        } else {
            x.style.display = "none";
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        var socket = io();

        socket.on('connect', function() {
            console.log("Connected to Dashboard.");
            socket.emit('start_monitoring', {});
        });

        socket.on('host_status_update', function(data) {
            var statusSpan = document.getElementById("status-" + data.host_id);
            var lastSeenCell = document.getElementById("last-seen-" + data.host_id);
            if (statusSpan) {
                statusSpan.style.color = data.is_online ? "green" : "red";
                statusSpan.innerText = data.is_online ? "Online" : "Offline";
            }
            if (lastSeenCell) lastSeenCell.innerText = data.last_seen;
        });

        // Obsługa nowego loga przez WebSocket (Aktualizacja tabeli)
        socket.on('new_log', function(data) {
            var tableBody = document.querySelector("#logs-table tbody");
            if (!tableBody) return;

            // Generujemy unikalne ID dla wiersza detali
            var uniqueId = Date.now() + Math.random().toString(36).substr(2, 9);
            
            // Parsowanie detali (jeśli są)
            // Backend w 'data' może przysłać surowe message, ale agent przesyła też szczegóły
            // W WebSocket payload (app.py) musisz upewnić się, że przesyłasz 'details' lub parsować message.
            // Tutaj zakładamy prostą prezentację, bo WebSocket w app.py wysyła uproszczony payload.
            // Aby uzyskać pełne detale przez socket, trzeba by zaktualizować app.py -> handle_start_monitoring.
            
            // Dla uproszczenia w wersji "live" z socketa pokażemy podstawy,
            // ale po odświeżeniu (z bazy) będą pełne dane.
            
            var row = tableBody.insertRow(0);
            row.style.backgroundColor = "#e8f5e9";
            setTimeout(() => { row.style.transition = "background 1s"; row.style.backgroundColor = "transparent"; }, 500);

            var color = data.severity === 'critical' ? 'red' : (data.severity === 'warning' ? 'orange' : 'black');

            row.innerHTML = `
                <td>${data.timestamp}</td>
                <td>${data.hostname}</td>
                <td><strong>${data.program}</strong></td>
                <td>${data.message.substring(0, 50)}...</td>
                <td style="font-weight: bold; color: ${color}">${data.severity}</td>
                <td><button onclick="alert('${data.message.replace(/'/g, "\\'")}')" class="btn" style="padding: 2px 8px; font-size: 0.8em;">Raw</button></td>
            `;
            
            // Usuń nadmiarowe wiersze
            var limit = {{ current_limit }};
            if(tableBody.rows.length > limit) {
                tableBody.deleteRow(limit);
            }
        });
    });
</script>

<h2>System Overview</h2>

<div class="card">
    <h3>Active Hosts</h3>
    {% if hosts %}
        <table>
            <thead>
                <tr>
                    <th>Hostname</th>
                    <th>IP Address</th>
                    <th>Last Heartbeat</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for host in hosts %}
                <tr>
                    <td>
                        <a href="{{ url_for('host_details', host_id=host.id) }}" style="font-weight: bold; color: #2980b9; text-decoration: none;">
                            {{ host.hostname }}
                        </a>
                    </td>
                    <td>{{ host.ip_address }}</td>
                    <td id="last-seen-{{ host.id }}">{{ host.last_heartbeat.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>
                        <span id="status-{{ host.id }}" style="color: {{ 'green' if host.is_online else 'red' }}">
                            {{ 'Online' if host.is_online else 'Offline' }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No hosts registered yet.</p>
    {% endif %}
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3>Recent Audit Logs</h3>
        <label for="limit-select">Show last:</label>
        <select id="limit-select">
            {% for val in [10, 20, 50, 100] %}
                <option value="{{ val }}" {% if request.args.get('limit', 20, type=int) == val %}selected{% endif %}>{{ val }}</option>
            {% endfor %}
        </select>
        <script>
            document.getElementById('limit-select').addEventListener('change', function() {
                const params = new URLSearchParams(window.location.search);
                params.set('limit', this.value);
                window.location.search = params.toString();
            });
        </script>

    {% if logs %}
        <table id="logs-table">
            <thead>
                <tr>
                    <th style="width: 15%;">Time</th>
                    <th style="width: 15%;">Host</th>
                    <th style="width: 15%;">Event Key</th>
                    <th style="width: 20%;">Executable / User</th>
                    <th style="width: 10%;">Severity</th>
                    <th style="width: 10%;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td>{{ log.timestamp.strftime('%H:%M:%S') }}</td>
                    <td>{{ log.host.hostname }}</td>
                    
                    <td>
                        <span style="background: #eef2f3; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #2c3e50;">
                            {{ log.details.get('key_label', 'unknown') if log.details else 'unknown' }}
                        </span>
                    </td>

                    <td>
                        {% if log.details and log.details.get('executable') %}
                            <div style="font-size: 0.9em; font-weight: bold;">{{ log.details.get('executable') }}</div>
                        {% endif %}
                        {% if log.details and log.details.get('uid') %}
                            <div style="font-size: 0.8em; color: #7f8c8d;">UID: {{ log.details.get('uid') }}</div>
                        {% endif %}
                        {% if not log.details or (not log.details.get('executable') and not log.details.get('uid')) %}
                            <span style="color: #ccc;">-</span>
                        {% endif %}
                    </td>

                    <td style="font-weight: bold; color: {{ 'red' if log.severity.value == 'critical' else 'orange' if log.severity.value == 'warning' else 'black' }}">
                        {{ log.severity.value }}
                    </td>
                    
                    <td>
                        <button onclick="toggleDetails({{ log.id }})" class="btn" style="padding: 4px 10px; font-size: 0.8em; background: #34495e;">
                            Details
                        </button>
                    </td>
                </tr>
                
                <tr id="raw-{{ log.id }}" style="display: none; background-color: #f8f9fa;">
                    <td colspan="6" style="padding: 10px;">
                        <div style="font-family: monospace; font-size: 0.85em; white-space: pre-wrap; word-break: break-all; color: #555;">
                            <strong>Raw Message:</strong><br>{{ log.message }}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No logs received yet.</p>
    {% endif %}
</div>
{% endblock %}