{% extends "base.html" %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
    // Funkcja do zmiany limitu - przeładowuje stronę z nowym parametrem GET
    function changeLimit(limit) {
        const url = new URL(window.location.href);
        url.searchParams.set('limit', limit);
        window.location.href = url.toString();
    }

    // Funkcja do pokazywania/ukrywania surowego loga
    function toggleDetails(rowId) {
        var x = document.getElementById("raw-" + rowId);
        if (x.style.display === "none") {
            x.style.display = "table-row";
        } else {
            x.style.display = "none";
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        var socket = io();

        socket.on('connect', function() {
            console.log("Connected to Dashboard.");
            // Żądamy monitorowania wszystkich hostów
            socket.emit('start_monitoring', {});
        });

        // Aktualizacja statusu hosta (Online/Offline)
        socket.on('host_status_update', function(data) {
            var statusSpan = document.getElementById("status-" + data.host_id);
            var lastSeenCell = document.getElementById("last-seen-" + data.host_id);
            
            if (statusSpan) {
                statusSpan.style.color = data.is_online ? "green" : "red";
                statusSpan.innerText = data.is_online ? "Online" : "Offline";
            }
            if (lastSeenCell) {
                lastSeenCell.innerText = data.last_seen;
            }
        });

        // Obsługa nowego loga przez WebSocket
        socket.on('new_log', function(data) {
            var tableBody = document.querySelector("#logs-table tbody");
            if (!tableBody) return;

            // Tworzymy nowy wiersz
            var row = tableBody.insertRow(0);
            
            // Animacja podświetlenia
            row.style.backgroundColor = "#e8f5e9";
            setTimeout(() => { 
                row.style.transition = "background 1s"; 
                row.style.backgroundColor = "transparent"; 
            }, 500);

            // Generujemy unikalne ID dla wiersza detali (na potrzeby toggle)
            var uniqueId = Date.now() + Math.random().toString(36).substr(2, 9);
            
            // --- PARSOWANIE PO STRONIE KLIENTA ---
            // Backend w 'app.py' wysyła tylko 'message', ale tabela wymaga 'key', 'exe', 'uid'.
            // Używamy Regex, aby wyciągnąć te dane z surowego stringa auditd,
            // żeby live logi wyglądały tak samo jak te z bazy.
            
            let keyLabel = "unknown";
            let executable = "";
            let uid = "";
            const msg = data.message || "";

            // Regex dla auditd (np. key="access", exe="/bin/cat", uid=1000)
            const keyMatch = msg.match(/key="?(\w+)"?/);
            if (keyMatch) keyLabel = keyMatch[1];

            const exeMatch = msg.match(/exe="?([^"\s]+)"?/);
            if (exeMatch) executable = exeMatch[1];

            const uidMatch = msg.match(/uid=(\d+)/);
            if (uidMatch) uid = "UID: " + uidMatch[1];

            // Kolorowanie severity
            var color = 'black';
            if (data.severity === 'critical') color = 'red';
            else if (data.severity === 'warning') color = 'orange';

            // HTML Wiersza Głównego
            row.innerHTML = `
                <td>${data.timestamp}</td>
                <td>${data.hostname}</td>
                
                <td>
                    <span style="background: #eef2f3; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #2c3e50;">
                        ${keyLabel}
                    </span>
                </td>

                <td>
                    ${executable ? `<div style="font-size: 0.9em; font-weight: bold;">${executable}</div>` : ''}
                    ${uid ? `<div style="font-size: 0.8em; color: #7f8c8d;">${uid}</div>` : ''}
                    ${!executable && !uid ? '<span style="color: #ccc;">-</span>' : ''}
                </td>

                <td style="font-weight: bold; color: ${color}">${data.severity}</td>
                
                <td>
                    <button onclick="toggleDetails('${uniqueId}')" class="btn" style="padding: 4px 10px; font-size: 0.8em; background: #34495e;">
                        Details
                    </button>
                </td>
            `;

            // Dodajemy wiersz z ukrytym surowym logiem zaraz pod spodem
            var rawRow = tableBody.insertRow(1);
            rawRow.id = "raw-" + uniqueId;
            rawRow.style.display = "none";
            rawRow.style.backgroundColor = "#f8f9fa";
            rawRow.innerHTML = `
                <td colspan="6" style="padding: 10px;">
                    <div style="font-family: monospace; font-size: 0.85em; white-space: pre-wrap; word-break: break-all; color: #555;">
                        <strong>Raw Message:</strong><br>${msg}
                    </div>
                </td>
            `;
            
            // Usuwamy nadmiarowe wiersze (utrzymujemy limit * 2, bo każdy log to 2 wiersze: główny + detale)
            // Pobieramy obecny limit z URL lub domyślnie 20
            const urlParams = new URLSearchParams(window.location.search);
            const limit = parseInt(urlParams.get('limit')) || 20;
            
            // deleteRow usuwa jeden <tr>, więc musimy pilnować pary
            if (tableBody.rows.length > limit * 2) {
                tableBody.deleteRow(tableBody.rows.length - 1); // Usuń ostatni raw
                tableBody.deleteRow(tableBody.rows.length - 1); // Usuń ostatni główny
            }
        });
    });
</script>

<h2>System Overview</h2>

<div class="card">
    <h3>Active Hosts</h3>
    {% if hosts %}
        <table>
            <thead>
                <tr>
                    <th>Hostname</th>
                    <th>IP Address</th>
                    <th>Last Heartbeat</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for host in hosts %}
                <tr>
                    <td>
                        <a href="{{ url_for('host_details', host_id=host.id) }}" style="font-weight: bold; color: #2980b9; text-decoration: none;">
                            {{ host.hostname }}
                        </a>
                    </td>
                    <td>{{ host.ip_address }}</td>
                    <td id="last-seen-{{ host.id }}">{{ host.last_heartbeat.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>
                        <span id="status-{{ host.id }}" style="color: {{ 'green' if host.is_online else 'red' }}">
                            {{ 'Online' if host.is_online else 'Offline' }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No hosts registered yet.</p>
    {% endif %}
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3>Recent Audit Logs</h3>
        
        <div>
            <label for="limit-select" style="margin-right: 5px;">Show last:</label>
            <select id="limit-select" onchange="changeLimit(this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                {% set current_limit = request.args.get('limit', 20)|int %}
                <option value="10" {% if current_limit == 10 %}selected{% endif %}>10</option>
                <option value="20" {% if current_limit == 20 %}selected{% endif %}>20 (Default)</option>
                <option value="50" {% if current_limit == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if current_limit == 100 %}selected{% endif %}>100</option>
            </select>
        </div>
    </div>

    <table id="logs-table">
        <thead>
            <tr>
                <th style="width: 15%;">Time</th>
                <th style="width: 15%;">Host</th>
                <th style="width: 15%;">Event Key</th>
                <th style="width: 25%;">Executable / User</th>
                <th style="width: 10%;">Severity</th>
                <th style="width: 10%;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% if logs %}
                {% for log in logs %}
                <tr>
                    <td>{{ log.timestamp.strftime('%H:%M:%S') }}</td>
                    <td>{{ log.host.hostname }}</td>
                    
                    <td>
                        <span style="background: #eef2f3; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #2c3e50;">
                            {{ log.details.get('key_label', 'unknown') if log.details else 'unknown' }}
                        </span>
                    </td>

                    <td>
                        {% if log.details and log.details.get('executable') %}
                            <div style="font-size: 0.9em; font-weight: bold;">{{ log.details.get('executable') }}</div>
                        {% endif %}
                        {% if log.details and log.details.get('uid') %}
                            <div style="font-size: 0.8em; color: #7f8c8d;">UID: {{ log.details.get('uid') }}</div>
                        {% endif %}
                        {% if not log.details or (not log.details.get('executable') and not log.details.get('uid')) %}
                            <span style="color: #ccc;">-</span>
                        {% endif %}
                    </td>

                    <td style="font-weight: bold; color: {{ 'red' if log.severity.value == 'critical' else 'orange' if log.severity.value == 'warning' else 'black' }}">
                        {{ log.severity.value }}
                    </td>
                    
                    <td>
                        <button onclick="toggleDetails({{ log.id }})" class="btn" style="padding: 4px 10px; font-size: 0.8em; background: #34495e;">
                            Details
                        </button>
                    </td>
                </tr>
                
                <tr id="raw-{{ log.id }}" style="display: none; background-color: #f8f9fa;">
                    <td colspan="6" style="padding: 10px;">
                        <div style="font-family: monospace; font-size: 0.85em; white-space: pre-wrap; word-break: break-all; color: #555;">
                            <strong>Raw Message:</strong><br>{{ log.message }}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px;">No logs found.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}