{% extends "base.html" %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
    // Zmiana limitu w URL
    function changeLimit(limit) {
        const url = new URL(window.location.href);
        url.searchParams.set('limit', limit);
        window.location.href = url.toString();
    }

    // Funkcja przeÅ‚Ä…czajÄ…ca widocznoÅ›Ä‡ detali
    function toggleDetails(id) {
        var rowId = "raw-" + id;
        var row = document.getElementById(rowId);
        if (row) {
            // PrzeÅ‚Ä…czamy miÄ™dzy 'table-row' a 'none'
            if (row.style.display === "none" || row.style.display === "") {
                row.style.display = "table-row";
            } else {
                row.style.display = "none";
            }
        }
    }

    function initChart() {
        const hostId = {{ host.id }};
        const fromInput = document.getElementById('date_from');
        const toInput = document.getElementById('date_to');
        const chartImg = document.getElementById('chart-img');
        const spinner = document.getElementById('chart-spinner');
        const pdfBtn = document.getElementById('pdf-btn');

        const urlParams = new URLSearchParams(window.location.search);
        
        if (!fromInput.value) {
            if (urlParams.get('date_from')) {
                fromInput.value = urlParams.get('date_from');
            } else {
                const yesterday = new Date(new Date().getTime() - (24 * 60 * 60 * 1000));
                fromInput.value = new Date(yesterday.getTime() - (yesterday.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            }
        }

        if (!toInput.value) {
            if (urlParams.get('date_to')) {
                toInput.value = urlParams.get('date_to');
            } else {
                const now = new Date();
                toInput.value = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            }
        }
        const chartUrl = `/host/${hostId}/chart_image?date_from=${fromInput.value}&date_to=${toInput.value}`;
        
        chartImg.onload = function() {
            spinner.style.display = 'none';
            chartImg.style.display = 'inline-block';
        };
        
        chartImg.onerror = function() {
            spinner.style.display = 'none';
        };
        chartImg.src = chartUrl;

        if(pdfBtn) {
            pdfBtn.href = `/host/${hostId}/report?date_from=${fromInput.value}&date_to=${toInput.value}`;
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        var socket = io();
        var currentHostId = {{ host.id }};

        socket.on('connect', function() {
            // Å»Ä…damy streamu tylko dla tego hosta
            socket.emit('start_monitoring', { 'host_id': currentHostId });
        });

        // Aktualizacja statusu
        socket.on('host_status_update', function(data) {
            if (data.host_id !== currentHostId) return;

            var statusSpan = document.getElementById("host-status");
            var lastSeenSpan = document.getElementById("host-last-seen");

            if (statusSpan) {
                statusSpan.style.color = data.is_online ? "#27ae60" : "#c0392b";
                statusSpan.innerText = data.is_online ? "(Online)" : "(Offline)";
            }
            if (lastSeenSpan) lastSeenSpan.innerText = data.last_seen;
        });

        // --- OBSÅUGA NOWEGO LOGA (LIVE) ---
        socket.on('new_log', function(data) {
            var tableBody = document.querySelector("#logs-table tbody");
            if (!tableBody) return;

            // UÅ¼ywamy ID z backendu (jeÅ›li jest) lub generujemy tymczasowe
            var logId = data.id || ("gen-" + Date.now());

            // --- Parsowanie JS (Regex) ---
            // WyciÄ…gamy detale z surowego stringa message, Å¼eby tabela live wyglÄ…daÅ‚a jak ta z bazy
            let keyLabel = "unknown";
            let executable = "";
            let uid = "";
            const msg = data.message || "";

            const keyMatch = msg.match(/key="?(\w+)"?/);
            if (keyMatch) keyLabel = keyMatch[1];

            const exeMatch = msg.match(/exe="?([^"\s]+)"?/);
            if (exeMatch) executable = exeMatch[1];

            const uidMatch = msg.match(/uid=(\d+)/);
            if (uidMatch) uid = "UID: " + uidMatch[1];

            var color = 'black';
            if (data.severity === 'critical') color = 'red';
            else if (data.severity === 'warning') color = 'orange';

            // 1. Wstawiamy Wiersz GÅ‚Ã³wny
            var row = tableBody.insertRow(0);
            row.style.backgroundColor = "#e8f5e9";
            setTimeout(() => { 
                row.style.transition = "background 1s"; 
                row.style.backgroundColor = "transparent"; 
            }, 500);

            row.innerHTML = `
                <td>${data.timestamp}</td>
                
                <td>
                    <span style="background: #eef2f3; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #2c3e50;">
                        ${keyLabel}
                    </span>
                </td>

                <td>
                    ${executable ? `<div style="font-size: 0.9em; font-weight: bold;">${executable}</div>` : ''}
                    ${uid ? `<div style="font-size: 0.8em; color: #7f8c8d;">${uid}</div>` : ''}
                    ${!executable && !uid ? '<span style="color: #ccc;">-</span>' : ''}
                </td>

                <td style="font-weight: bold; color: ${color}">${data.severity}</td>
                
                <td>
                    <button onclick="toggleDetails('${logId}')" class="btn" style="padding: 4px 10px; font-size: 0.8em; background: #34495e;">
                        Details
                    </button>
                </td>
            `;

            // 2. Wstawiamy Ukryty Wiersz (Raw Message)
            var rawRow = tableBody.insertRow(1);
            rawRow.id = "raw-" + logId; // ID pasujÄ…ce do toggleDetails
            rawRow.style.display = "none";
            rawRow.style.backgroundColor = "#f8f9fa";
            rawRow.innerHTML = `
                <td colspan="5" style="padding: 10px;">
                    <div style="font-family: monospace; font-size: 0.85em; white-space: pre-wrap; word-break: break-all; color: #555;">
                        <strong>Raw Message:</strong><br>${msg}
                    </div>
                </td>
            `;

            // 3. Utrzymanie limitu wierszy (limit * 2, bo kaÅ¼dy log to 2 wiersze)
            const urlParams = new URLSearchParams(window.location.search);
            const limit = parseInt(urlParams.get('limit')) || 20;
            
            while (tableBody.rows.length > limit * 2) {
                tableBody.deleteRow(tableBody.rows.length - 1);
            }
        });
    });
</script>

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('dashboard') }}" class="btn" style="background: #95a5a6;">&larr; Back to Dashboard</a>
</div>

<h2>
    Host: <span style="color: #2980b9;">{{ host.hostname }}</span>
    <span id="host-status" style="font-size: 0.6em; vertical-align: middle; color: {{ '#27ae60' if host.is_online else '#c0392b' }}">
        {{ '(Online)' if host.is_online else '(Offline)' }}
    </span>
</h2>
<p>IP: {{ host.ip_address }} | Last Seen: <span id="host-last-seen">{{ host.last_heartbeat.strftime('%Y-%m-%d %H:%M:%S') }}</span></p>

<div class="card">
    <h3>Audit Rules Configuration</h3>
    <table>
        <thead>
            <tr>
                <th>Path</th>
                <th>Permissions</th>
                <th>Key</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for rule in host.rules %}
            <tr>
                <td>{{ rule.path }}</td>
                <td>{{ rule.permissions }}</td>
                <td>{{ rule.key_label }}</td>
                <td>
                    <form action="{{ url_for('delete_rule_from_host', host_id=host.id, rule_id=rule.id) }}" method="POST" style="display:inline;">
                        <button type="submit" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px;">Remove</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <h4 style="margin-top: 20px;">Add New Rule</h4>
    <form action="{{ url_for('add_rule_to_host', host_id=host.id) }}" method="POST" style="display: flex; gap: 10px;">
        <input type="text" name="path" placeholder="/path/to/monitor" required style="flex: 2; padding: 8px;">
        <select name="permissions" style="padding: 8px;">
            <option value="wa">Write/Attribute (wa)</option>
            <option value="rwxa">Read/Write/Exec/Attr (rwxa)</option>
            <option value="x">Execute (x)</option>
        </select>
        <input type="text" name="key_label" placeholder="log_key_name" required style="flex: 1; padding: 8px;">
        <button type="submit" class="btn" style="background: #27ae60;">Add Rule</button>
    </form>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3>Statistics & Trends</h3>
        
        <form method="GET" action="{{ url_for('host_details', host_id=host.id) }}" style="display: flex; align-items: center; gap: 10px;">
            <input type="hidden" name="limit" value="{{ current_limit }}">
            <input type="hidden" name="q" value="{{ search_query }}">

            <div style="display: flex; flex-direction: column;">
                <label for="date_from" style="font-size: 0.8em; color: #666;">From:</label>
                <input type="datetime-local" id="date_from" name="date_from" 
                       style="padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="display: flex; flex-direction: column;">
                <label for="date_to" style="font-size: 0.8em; color: #666;">To:</label>
                <input type="datetime-local" id="date_to" name="date_to" 
                       style="padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <button type="submit" class="btn" style="height: 36px; margin-top: 14px; background: #2c3e50;">Apply Filter</button>
        </form>
    </div>

    <div style="width: 100%; overflow-x: auto; text-align: center; min-height: 250px; position: relative;">
        
        <div id="chart-spinner" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #7f8c8d; font-family: sans-serif;">
            Loading chart...
        </div>
        
        <img id="chart-img" src="" alt="Logs Chart" 
             style="display: none; max-width: 100%; height: auto; border: 1px solid #eee; border-radius: 4px;">
    </div>
        
    <div style="text-align: center; margin-top: 15px;">
        <a id="pdf-btn" href="#" class="btn" style="background: #e74c3c; padding: 10px 20px; font-weight: bold;">
            ðŸ“„ Download PDF Report
        </a>
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">Recent Logs for {{ host.hostname }}</h3>
        
        <div style="display: flex; gap: 10px;">
            <form method="GET" action="{{ url_for('host_details', host_id=host.id) }}" style="display: flex; gap: 5px;">
                <input type="hidden" name="limit" value="{{ current_limit }}">
                <input type="text" name="q" value="{{ search_query }}" placeholder="Search..." style="padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                <button type="submit" class="btn" style="padding: 6px 12px; font-size: 0.9em;">Search</button>
                {% if search_query %}
                    <a href="{{ url_for('host_details', host_id=host.id) }}" class="btn" style="background: #95a5a6; padding: 6px 12px; font-size: 0.9em;">Clear</a>
                {% endif %}
            </form>

            <select id="limit-select" onchange="changeLimit(this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="10" {% if current_limit == 10 %}selected{% endif %}>10</option>
                <option value="20" {% if current_limit == 20 %}selected{% endif %}>20 (Default)</option>
                <option value="50" {% if current_limit == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if current_limit == 100 %}selected{% endif %}>100</option>
            </select>
        </div>
    </div>

    <table id="logs-table">
        <thead>
            <tr>
                <th style="width: 15%;">Time</th>
                <th style="width: 15%;">Event Key</th>
                <th style="width: 25%;">Executable / User</th>
                <th style="width: 10%;">Severity</th>
                <th style="width: 10%;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.timestamp.strftime('%H:%M:%S') }}</td>
                
                <td>
                    <span style="background: #eef2f3; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #2c3e50;">
                        {{ log.details.get('key_label', 'unknown') if log.details else 'unknown' }}
                    </span>
                </td>

                <td>
                    {% if log.details and log.details.get('executable') %}
                        <div style="font-size: 0.9em; font-weight: bold;">{{ log.details.get('executable') }}</div>
                    {% endif %}
                    {% if log.details and log.details.get('uid') %}
                        <div style="font-size: 0.8em; color: #7f8c8d;">UID: {{ log.details.get('uid') }}</div>
                    {% endif %}
                     {% if not log.details or (not log.details.get('executable') and not log.details.get('uid')) %}
                        <span style="color: #ccc;">-</span>
                    {% endif %}
                </td>

                <td style="font-weight: bold; color: {{ 'red' if log.severity.value == 'critical' else 'orange' if log.severity.value == 'warning' else 'black' }}">
                    {{ log.severity.value }}
                </td>

                <td>
                    <button onclick="toggleDetails('{{ log.id }}')" class="btn" style="padding: 4px 10px; font-size: 0.8em; background: #34495e;">
                        Details
                    </button>
                </td>
            </tr>
            <tr id="raw-{{ log.id }}" style="display: none; background-color: #f8f9fa;">
                <td colspan="5" style="padding: 10px;">
                    <div style="font-family: monospace; font-size: 0.85em; white-space: pre-wrap; word-break: break-all; color: #555;">
                        <strong>Raw Message:</strong><br>{{ log.message }}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}