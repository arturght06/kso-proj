{% extends "base.html" %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
    function changeLimit(limit) {
        const url = new URL(window.location.href);
        url.searchParams.set('limit', limit);
        window.location.href = url.toString();
    }

    function toggleDetails(rowId) {
        var x = document.getElementById("raw-" + rowId);
        x.style.display = (x.style.display === "none") ? "table-row" : "none";
    }

    document.addEventListener("DOMContentLoaded", function() {
        var socket = io();
        var currentHostId = {{ host.id }};

        socket.on('connect', function() {
            socket.emit('start_monitoring', { 'host_id': currentHostId });
        });

        socket.on('host_status_update', function(data) {
            if (data.host_id !== currentHostId) return;
            var statusSpan = document.getElementById("host-status");
            var lastSeenSpan = document.getElementById("host-last-seen");
            if (statusSpan) {
                statusSpan.style.color = data.is_online ? "#27ae60" : "#c0392b";
                statusSpan.innerText = data.is_online ? "(Online)" : "(Offline)";
            }
            if (lastSeenSpan) lastSeenSpan.innerText = data.last_seen;
        });

        // Obsługa Live Logów (Uproszczona)
        socket.on('new_log', function(data) {
            var tableBody = document.querySelector("#logs-table tbody");
            if (!tableBody) return;

            var row = tableBody.insertRow(0);
            row.style.backgroundColor = "#fff3cd";
            setTimeout(() => { row.style.transition = "background 1s"; row.style.backgroundColor = "transparent"; }, 500);

            var color = data.severity === 'critical' ? 'red' : (data.severity === 'warning' ? 'orange' : 'black');

            // Dla socketa wstawiamy uproszczony widok lub przycisk alert
            row.innerHTML = `
                <td>${data.timestamp}</td>
                <td><strong>${data.program}</strong></td>
                <td>${data.message.substring(0,60)}...</td>
                <td style="color: ${color}">${data.severity}</td>
                <td><button onclick="alert('Reload page to see full details')" class="btn" style="padding: 2px 8px; font-size: 0.8em; opacity: 0.5;">New</button></td>
            `;
            
            var limit = {{ current_limit }};
            if(tableBody.rows.length > limit) tableBody.deleteRow(limit);
        });
    });
</script>

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('dashboard') }}" class="btn" style="background: #95a5a6;">&larr; Back to Dashboard</a>
</div>

<h2>
    Host: <span style="color: #2980b9;">{{ host.hostname }}</span>
    <span id="host-status" style="font-size: 0.6em; vertical-align: middle; color: {{ '#27ae60' if host.is_online else '#c0392b' }}">
        {{ '(Online)' if host.is_online else '(Offline)' }}
    </span>
</h2>
<p>IP: {{ host.ip_address }} | Last Seen: <span id="host-last-seen">{{ host.last_heartbeat.strftime('%Y-%m-%d %H:%M:%S') }}</span></p>

<div class="card">
    <h3>Audit Rules Configuration</h3>
    <table>
        <thead>
            <tr>
                <th>Path</th>
                <th>Permissions</th>
                <th>Key</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for rule in host.rules %}
            <tr>
                <td>{{ rule.path }}</td>
                <td>{{ rule.permissions }}</td>
                <td>{{ rule.key_label }}</td>
                <td>
                    <form action="{{ url_for('delete_rule_from_host', host_id=host.id, rule_id=rule.id) }}" method="POST" style="display:inline;">
                        <button type="submit" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px;">Remove</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <h4 style="margin-top: 20px;">Add New Rule</h4>
    <form action="{{ url_for('add_rule_to_host', host_id=host.id) }}" method="POST" style="display: flex; gap: 10px;">
        <input type="text" name="path" placeholder="/path/to/monitor" required style="flex: 2; padding: 8px;">
        <select name="permissions" style="padding: 8px;">
            <option value="wa">Write/Attribute (wa)</option>
            <option value="rwxa">Read/Write/Exec/Attr (rwxa)</option>
            <option value="x">Execute (x)</option>
        </select>
        <input type="text" name="key_label" placeholder="log_key_name" required style="flex: 1; padding: 8px;">
        <button type="submit" class="btn" style="background: #27ae60;">Add Rule</button>
    </form>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">Recent Logs for {{ host.hostname }}</h3>
        
        <div style="display: flex; gap: 10px;">
            <form method="GET" action="{{ url_for('host_details', host_id=host.id) }}" style="display: flex; gap: 5px;">
                <input type="hidden" name="limit" value="{{ current_limit }}">
                <input type="text" name="q" value="{{ search_query }}" placeholder="Search..." style="padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                <button type="submit" class="btn" style="padding: 6px 12px; font-size: 0.9em;">Search</button>
                {% if search_query %}
                    <a href="{{ url_for('host_details', host_id=host.id) }}" class="btn" style="background: #95a5a6; padding: 6px 12px; font-size: 0.9em;">Clear</a>
                {% endif %}
            </form>

            <select id="limit-select" onchange="changeLimit(this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="10" {% if current_limit == 10 %}selected{% endif %}>10</option>
                <option value="20" {% if current_limit == 20 %}selected{% endif %}>20 (Default)</option>
                <option value="50" {% if current_limit == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if current_limit == 100 %}selected{% endif %}>100</option>
            </select>
        </div>
    </div>

    <table id="logs-table">
        <thead>
            <tr>
                <th style="width: 15%;">Time</th>
                <th style="width: 15%;">Event Key</th>
                <th style="width: 25%;">Executable / User</th>
                <th style="width: 10%;">Severity</th>
                <th style="width: 10%;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.timestamp.strftime('%H:%M:%S') }}</td>
                
                <td>
                    <span style="background: #eef2f3; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #2c3e50;">
                        {{ log.details.get('key_label', 'unknown') if log.details else 'unknown' }}
                    </span>
                </td>

                <td>
                    {% if log.details and log.details.get('executable') %}
                        <div style="font-size: 0.9em; font-weight: bold;">{{ log.details.get('executable') }}</div>
                    {% endif %}
                    {% if log.details and log.details.get('uid') %}
                        <div style="font-size: 0.8em; color: #7f8c8d;">UID: {{ log.details.get('uid') }}</div>
                    {% endif %}
                     {% if not log.details or (not log.details.get('executable') and not log.details.get('uid')) %}
                        <span style="color: #ccc;">-</span>
                    {% endif %}
                </td>

                <td style="font-weight: bold; color: {{ 'red' if log.severity.value == 'critical' else 'orange' if log.severity.value == 'warning' else 'black' }}">
                    {{ log.severity.value }}
                </td>

                <td>
                    <button onclick="toggleDetails({{ log.id }})" class="btn" style="padding: 4px 10px; font-size: 0.8em; background: #34495e;">
                        Details
                    </button>
                </td>
            </tr>
            <tr id="raw-{{ log.id }}" style="display: none; background-color: #f8f9fa;">
                <td colspan="5" style="padding: 10px;">
                    <div style="font-family: monospace; font-size: 0.85em; white-space: pre-wrap; word-break: break-all; color: #555;">
                        <strong>Raw Message:</strong><br>{{ log.message }}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}