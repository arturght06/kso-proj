{% extends "base.html" %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        var socket = io();
        
        // Pobieramy ID hosta z szablonu Jinja do zmiennej JS
        var currentHostId = {{ host.id }};

        socket.on('connect', function() {
            console.log("Connected. Requesting stream for Host ID: " + currentHostId);
            // Wysyłamy żądanie monitorowania KONKRETNEGO hosta
            socket.emit('start_monitoring', { 'host_id': currentHostId });
        });

        // 1. Aktualizacja statusu
        socket.on('host_status_update', function(data) {
            // Ignoruj, jeśli to update innego hosta (zabezpieczenie)
            if (data.host_id !== currentHostId) return;

            var statusSpan = document.getElementById("host-status");
            var lastSeenSpan = document.getElementById("host-last-seen");

            if (statusSpan) {
                if (data.is_online) {
                    statusSpan.style.color = "#27ae60"; // Zielony
                    statusSpan.innerText = "(Online)";
                } else {
                    statusSpan.style.color = "#c0392b"; // Czerwony
                    statusSpan.innerText = "(Offline)";
                }
            }
            if (lastSeenSpan) {
                lastSeenSpan.innerText = data.last_seen;
            }
        });

        // 2. Nowe logi
        socket.on('new_log', function(data) {
            var tableBody = document.querySelector("#logs-table tbody");
            var row = tableBody.insertRow(0);
            
            // Animacja podświetlenia nowego wiersza
            row.style.backgroundColor = "#fff3cd";
            setTimeout(() => { row.style.transition = "background 1s"; row.style.backgroundColor = "transparent"; }, 500);

            var color = 'black';
            if(data.severity === 'critical') color = 'red';
            else if(data.severity === 'warning') color = 'orange';

            row.innerHTML = `
                <td>${data.timestamp}</td>
                <td>${data.program}</td>
                <td style="font-family: monospace; font-size: 0.9em;">${data.message.substring(0, 120)}...</td>
                <td style="color: ${color}">${data.severity}</td>
            `;

            if(tableBody.rows.length > 50) {
                tableBody.deleteRow(50);
            }
        });
    });
</script>

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('dashboard') }}" class="btn" style="background: #95a5a6;">&larr; Back to Dashboard</a>
</div>

<h2>
    Host: <span style="color: #2980b9;">{{ host.hostname }}</span>
    <span id="host-status" style="font-size: 0.6em; vertical-align: middle; color: {{ '#27ae60' if host.is_online else '#c0392b' }}">
        {{ '(Online)' if host.is_online else '(Offline)' }}
    </span>
</h2>

<p>IP: {{ host.ip_address }} | Last Seen: <span id="host-last-seen">{{ host.last_heartbeat.strftime('%Y-%m-%d %H:%M:%S') }}</span></p>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">Recent Logs for {{ host.hostname }}</h3>
        
        <form method="GET" action="{{ url_for('host_details', host_id=host.id) }}" style="display: flex; gap: 5px;">
            <input type="text" name="q" value="{{ search_query }}" placeholder="Search logs..." style="padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
            <button type="submit" class="btn" style="padding: 6px 12px; font-size: 0.9em;">Search</button>
            {% if search_query %}
                <a href="{{ url_for('host_details', host_id=host.id) }}" class="btn" style="background: #95a5a6; padding: 6px 12px; font-size: 0.9em;">Clear</a>
            {% endif %}
        </form>
    </div>

    <table id="logs-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Program</th>
                <th>Message</th>
                <th>Severity</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.timestamp.strftime('%H:%M:%S') }}</td>
                <td>{{ log.program }}</td>
                <td style="font-family: monospace; font-size: 0.9em;">{{ log.message[:120] }}...</td>
                <td style="color: {{ 'red' if log.severity.value == 'critical' else 'black' }}">{{ log.severity.value }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}