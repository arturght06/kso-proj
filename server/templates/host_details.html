{% extends "base.html" %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
    // Zmiana limitu w URL
    function changeLimit(limit) {
        const url = new URL(window.location.href);
        url.searchParams.set('limit', limit);
        window.location.href = url.toString();
    }

    // Pokazywanie/ukrywanie wiersza z surowym logiem
    function toggleDetails(id) {
        var rowId = "raw-" + id;
        var row = document.getElementById(rowId);
        if (row) {
            row.style.display = (row.style.display === "none" || row.style.display === "") ? "table-row" : "none";
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        var socket = io();
        // Pobieramy ID hosta z szablonu Jinja
        var currentHostId = {{ host.id }};

        socket.on('connect', function() {
            console.log("Connected to Host Details. ID: " + currentHostId);
            // Żądamy streamu tylko dla tego hosta
            socket.emit('start_monitoring', { 'host_id': currentHostId });
        });

        // Aktualizacja statusu (Online/Offline)
        socket.on('host_status_update', function(data) {
            if (data.host_id !== currentHostId) return;

            var statusSpan = document.getElementById("host-status");
            var lastSeenSpan = document.getElementById("host-last-seen");

            if (statusSpan) {
                statusSpan.style.color = data.is_online ? "#27ae60" : "#c0392b";
                statusSpan.innerText = data.is_online ? "(Online)" : "(Offline)";
            }
            if (lastSeenSpan) lastSeenSpan.innerText = data.last_seen;
        });

        // Obsługa nowego loga (LIVE)
        socket.on('new_log', function(data) {
            var tableBody = document.querySelector("#logs-table tbody");
            if (!tableBody) return;

            // Używamy ID z backendu lub generujemy tymczasowe
            var logId = data.id || ("gen-" + Date.now());

            // --- Parsowanie JS (Regex) żeby wyciągnąć detale z message ---
            let keyLabel = "unknown";
            let executable = "";
            let uid = "";
            const msg = data.message || "";

            const keyMatch = msg.match(/key="?(\w+)"?/);
            if (keyMatch) keyLabel = keyMatch[1];

            const exeMatch = msg.match(/exe="?([^"\s]+)"?/);
            if (exeMatch) executable = exeMatch[1];

            const uidMatch = msg.match(/uid=(\d+)/);
            if (uidMatch) uid = "UID: " + uidMatch[1];

            var color = 'black';
            if (data.severity === 'critical') color = 'red';
            else if (data.severity === 'warning') color = 'orange';

            // 1. Wiersz Główny
            var row = tableBody.insertRow(0);
            row.style.backgroundColor = "#e8f5e9";
            setTimeout(() => { 
                row.style.transition = "background 1s"; 
                row.style.backgroundColor = "transparent"; 
            }, 500);

            row.innerHTML = `
                <td>${data.timestamp}</td>
                
                <td>
                    <span style="background: #eef2f3; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #2c3e50;">
                        ${keyLabel}
                    </span>
                </td>

                <td>
                    ${executable ? `<div style="font-size: 0.9em; font-weight: bold;">${executable}</div>` : ''}
                    ${uid ? `<div style="font-size: 0.8em; color: #7f8c8d;">${uid}</div>` : ''}
                    ${!executable && !uid ? '<span style="color: #ccc;">-</span>' : ''}
                </td>

                <td style="font-weight: bold; color: ${color}">${data.severity}</td>
                
                <td>
                    <button onclick="toggleDetails('${logId}')" class="btn" style="padding: 4px 10px; font-size: 0.8em; background: #34495e;">
                        Details
                    </button>
                </td>
            `;

            // 2. Wiersz Ukryty (Raw)
            var rawRow = tableBody.insertRow(1);
            rawRow.id = "raw-" + logId;
            rawRow.style.display = "none";
            rawRow.style.backgroundColor = "#f8f9fa";
            rawRow.innerHTML = `
                <td colspan="5" style="padding: 10px;">
                    <div style="font-family: monospace; font-size: 0.85em; white-space: pre-wrap; word-break: break-all; color: #555;">
                        <strong>Raw Message:</strong><br>${msg}
                    </div>
                </td>
            `;

            // Utrzymanie limitu wierszy
            const urlParams = new URLSearchParams(window.location.search);
            const limit = parseInt(urlParams.get('limit')) || 20;
            
            while (tableBody.rows.length > limit * 2) {
                tableBody.deleteRow(tableBody.rows.length - 1);
            }
        });
    });
</script>

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('dashboard') }}" class="btn" style="background: #95a5a6;">&larr; Back to Dashboard</a>
</div>

<h2>
    Host: <span style="color: #2980b9;">{{ host.hostname }}</span>
    <span id="host-status" style="font-size: 0.6em; vertical-align: middle; color: {{ '#27ae60' if host.is_online else '#c0392b' }}">
        {{ '(Online)' if host.is_online else '(Offline)' }}
    </span>
</h2>
<p>IP: {{ host.ip_address }} | Last Seen: <span id="host-last-seen">{{ host.last_heartbeat.strftime('%Y-%m-%d %H:%M:%S') }}</span></p>

<div class="card">
    <h3>Audit Rules Configuration</h3>
    <p style="font-size: 0.9em; color: #666;">Changes are synced every heartbeat (5s).</p>
    
    <table>
        <thead>
            <tr>
                <th>Path</th>
                <th>Permissions</th>
                <th>Key</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for rule in host.rules %}
            <tr>
                <td>{{ rule.path }}</td>
                <td>{{ rule.permissions }}</td>
                <td>{{ rule.key_label }}</td>
                <td>
                    <form action="{{ url_for('delete_rule_from_host', host_id=host.id, rule_id=rule.id) }}" method="POST" style="display:inline;">
                        <button type="submit" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px;">Remove</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h4 style="margin-top: 20px;">Add New Rule</h4>
    <form action="{{ url_for('add_rule_to_host', host_id=host.id) }}" method="POST" style="display: flex; gap: 10px;">
        <input type="text" name="path" placeholder="/path/to/monitor" required style="flex: 2; padding: 8px;">
        <select name="permissions" style="padding: 8px;">
            <option value="wa">Write/Attribute (wa)</option>
            <option value="rwxa">Read/Write/Exec/Attr (rwxa)</option>
            <option value="x">Execute (x)</option>
        </select>
        <input type="text" name="key_label" placeholder="log_key_name" required style="flex: 1; padding: 8px;">
        <button type="submit" class="btn" style="background: #27ae60;">Add Rule</button>
    </form>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">Recent Logs</h3>
        
        <div style="display: flex; gap: 10px;">
            <form method="GET" action="{{ url_for('host_details', host_id=host.id) }}" style="display: flex; gap: 5px;">
                <input type="hidden" name="limit" value="{{ current_limit }}">
                <input type="text" name="q" value="{{ search_query }}" placeholder="Search logs..." style="padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                <button type="submit" class="btn" style="padding: 6px 12px; font-size: 0.9em;">Search</button>
                {% if search_query %}
                    <a href="{{ url_for('host_details', host_id=host.id) }}" class="btn" style="background: #95a5a6; padding: 6px 12px; font-size: 0.9em;">Clear</a>
                {% endif %}
            </form>

            <select onchange="changeLimit(this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                {% set current_limit = request.args.get('limit', 20)|int %}
                <option value="10" {% if current_limit == 10 %}selected{% endif %}>10</option>
                <option value="20" {% if current_limit == 20 %}selected{% endif %}>20</option>
                <option value="50" {% if current_limit == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if current_limit == 100 %}selected{% endif %}>100</option>
            </select>
        </div>
    </div>

    <table id="logs-table">
        <thead>
            <tr>
                <th style="width: 15%;">Time</th>
                <th style="width: 20%;">Event Key</th>
                <th style="width: 30%;">Executable / User</th>
                <th style="width: 15%;">Severity</th>
                <th style="width: 10%;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% if logs %}
                {% for log in logs %}
                <tr>
                    <td>{{ log.timestamp.strftime('%H:%M:%S') }}</td>
                    
                    <td>
                        <span style="background: #eef2f3; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #2c3e50;">
                            {{ log.details.get('key_label', 'unknown') if log.details else 'unknown' }}
                        </span>
                    </td>

                    <td>
                        {% if log.details and log.details.get('executable') %}
                            <div style="font-size: 0.9em; font-weight: bold;">{{ log.details.get('executable') }}</div>
                        {% endif %}
                        {% if log.details and log.details.get('uid') %}
                            <div style="font-size: 0.8em; color: #7f8c8d;">UID: {{ log.details.get('uid') }}</div>
                        {% endif %}
                        {% if not log.details or (not log.details.get('executable') and not log.details.get('uid')) %}
                            <span style="color: #ccc;">-</span>
                        {% endif %}
                    </td>

                    <td style="font-weight: bold; color: {{ 'red' if log.severity.value == 'critical' else 'orange' if log.severity.value == 'warning' else 'black' }}">
                        {{ log.severity.value }}
                    </td>

                    <td>
                        <button onclick="toggleDetails('{{ log.id }}')" class="btn" style="padding: 4px 10px; font-size: 0.8em; background: #34495e;">
                            Details
                        </button>
                    </td>
                </tr>
                
                <tr id="raw-{{ log.id }}" style="display: none; background-color: #f8f9fa;">
                    <td colspan="5" style="padding: 10px;">
                        <div style="font-family: monospace; font-size: 0.85em; white-space: pre-wrap; word-break: break-all; color: #555;">
                            <strong>Raw Message:</strong><br>{{ log.message }}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px; color: #777;">No logs found matching criteria.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}